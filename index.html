<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Anonymous Grading System</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="icon" type="image/x-icon" href="assets/img/incognito.png">
    <style>
      .linesu {
        border-left: 3px solid rgba(69, 69, 69, 0.493);
        height: 500px;
      }
    </style>
</head>
  <body>
    <script>

    //File Input Validation
    function validateFileInput(inputesto) {
      var elemento, btn;
      if(inputesto === "customFileA")
      {
        elemento = document.getElementById("teachersOutput");
        btn = document.getElementById("teachersSubmit");

      } else if (inputesto === "customFileB") {
        elemento = document.getElementById("studentsOutput");
        btn = document.getElementById("studentsSubmit");
      }
      
      var fileName = document.getElementById(inputesto).value;
      var extensions = new Array("csv","xls","xlsx");
      var file_extension = fileName.split('.').pop(); 
      for(var i = 0; i < extensions.length; i++)
      {
        if(extensions[i]==file_extension)
        {
          btn.disabled = false;
          elemento.innerHTML = "<br>";
          return;
        }
      }
      elemento.innerHTML="<p class='text-danger'>Invalid file. Only .csv, .xls, or .xlsx files are allowed.</p>";
      btn.disabled = true;
    }

    // function validateTextInput(inputestwo) {
    //   //To add later
    // }

    // function validateForm() {
    //   const studentNo = document.getElementById('studentsTextInputA').value;
    //   const submitButton = document.getElementById('studentsSubmit');
    //   if (studentNo.trim() === "") {
    //       submitButton.disabled = true;
    //   } else {
    //       submitButton.disabled = false;
    //   }
    // }

    // Generate CSV Function
    function generateCSV() {
    const slider = document.getElementById("rangeRow");
    const sliderValue = slider.value;

    const data = [
      ['Name', 'Student No.', 'Grade (%)']
    ];

    Array.from({length: sliderValue}).forEach((_, i) => {
      data.push(['Name', `Student${i + 1}`, '0']);
    });

    const csvContent = data.map(row => row.join(',')).join('\n');

    const filename = 'sample.csv';
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });

      if (navigator.msSaveBlob) {
          navigator.msSaveBlob(blob, filename);
      } else {
          const link = document.createElement('a');
          if (link.download !== undefined) {
              const url = URL.createObjectURL(blob);
              link.setAttribute('href', url);
              link.setAttribute('download', filename);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
          }
      }
    }

    // Decrypt Function
    function retrieveGradeByStudentNo(csvData, studentNumber) {
      const lines = csvData.trim().split('\n');
      
      const headers = lines[0].split(',');

      const studentNoIndex = headers.indexOf('Student No.');
      //To fix (\r)
      const gradeIndex = headers.indexOf('Grade (%)\r');
      if (studentNoIndex === -1 || gradeIndex === -1) {
          return '{Error: Invalid file format}';
      }

      for (let i = 1; i < lines.length; i++) {
          const cells = lines[i].split(',');

          if (cells[studentNoIndex].trim() == studentNumber) {
              return cells[gradeIndex].trim();
          }
      }
      // resultElement.innerHTML = "<p class='text-danger'>Student not found. Please check your input and try again.</p>"
      return 'Student not found. Please check your input and try again.';
    }

    //Test Submit Function
    function retrieveGrade() {
      const fileInput = document.getElementById('customFileB');
      const studentNumber = document.getElementById('studentsTextInputA').value;
      const resultElement = document.getElementById('studentsOutput');

      if (!fileInput.files.length) {
          resultElement.innerHTML = "<p class='text-danger'>Please select a file.</p>";
          document.getElementById("studentsSubmit").disabled = true;
          return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const csvData = e.target.result;
        const grade = Number(retrieveGradeByStudentNo(csvData, studentNumber));
        
        console.log("StudentNo: " + studentNumber);
        console.log("Grade: " + grade);
        console.log(typeof studentNumber);
        if (studentNumber === "") {
          resultElement.innerHTML = "<p class='text-danger'>Invalid student number. Please try again.</p>";
        } else if (!Number.isInteger(grade)) {
          resultElement.innerHTML = "<p class='text-danger'>Student not found. Please try again.</p>";
        } else {
          // resultElement.textContent = `The grade for student number ${studentNumber} is: ${grade}`;
          resultElement.innerHTML = "<p class='text-success'>The grade for student number <b>" + studentNumber + "</b> is: <b>" + grade + "</b></p>";
        }
      };

      reader.onerror = function() {
          resultElement.textContent = 'Error reading file';
      };

      reader.readAsText(file);
    }
    </script>

    <div class="container">
        <div class="row mt-3">
          <!-- Teachers -->
          <div class="col-sm">
            <h1><span class="label label-primary">Teachers</span></h1> 
            <label class="form-label my-3" for="customFileA">File Upload (Existing CSV)</label>
              <input type="file" class="form-control" id="customFileA" accept=".csv,.xls,.xlsx" onchange="validateFileInput(this.id);">
              <input type="text" class="form-control my-3" id="teachersTextInput" placeholder="Enter secret key/passphrase">
              <div class="d-flex justify-content-center">
                <input type="submit" class="my-2 justify-content-center" id="teachersSubmit" value="Encrypt" onclick="return false;" disabled>
              </div>
            <hr class="my-12"/>
            <div id="teachersOutput" ><p class="text-danger">Please fill out all required fields.</p></div>
          </div>
            <div class="linesu ml-3 mr-3"></div>
          

          <!-- Students -->
          <div class="col-sm">
            <h1><span class="label label-default">Students</span></h1>
            <label class="form-label my-3" for="customFileB" pattern="^.+\.(xlsx|xls|csv)$">File Upload (Existing CSV)</label>
              <input type="file" class="form-control" id="customFileB" accept=".csv,.xls,.xlsx" onchange="validateFileInput(this.id);"/>
              <div class="d-flex justify-content-center">
                <input type="number" class="form-control my-3 mr-1" id="studentsTextInputA" placeholder="Enter Student No."/>
                <input type="text" class="form-control my-3 ml-1" id="studentsTextInputB" placeholder="Enter secret key/passphrase" />
              </div>
              <div class="d-flex justify-content-center">
                <input type="submit" class="my-2 justify-content-center" id="studentsSubmit" value="Decrypt" onclick="retrieveGrade();" disabled>
              </div>
            <hr class="my-12"/>
            <div id="studentsOutput" class="text-info"><p class="text-danger">Please fill out all required fields.</p></div>
          </div>
        </div>
        <hr class="hr hr-blurry" />
    </div>

    <button href="#collapso" type="button" class="btn btn-secondary btn-lg mt-3 mb-3" data-toggle="collapse">Generate Sample CSV</button>
    <div id="collapso" class="collapse border p-3 mb-2 bg-secondary text-white">

      <!-- <label for="rangeCol" class="form-label">No. of Columns</label>
      <input type="range" class="form-range ml-3" id="rangeCol" min="1" max="20" value="10">
      <output id="outputCol"></output><br> -->

      <label for="rangeRow" class="form-label">No. of Students</label>
      <input type="range" class="form-range ml-3 mx-3" id="rangeRow" min="1" max="200" value="50" step="1">
      <output id="outputRow" class="font-weight-bold"></output><br>
      <button type="button" class="btn btn-outline-light my-3" onclick="generateCSV();">Generate</button>
    </div>
    <script>
    var sliderRow = document.getElementById("rangeRow");
    var outputRow = document.getElementById("outputRow");
    outputRow.innerHTML = sliderRow.value;
    sliderRow.oninput = function() {outputRow.innerHTML = this.value;}
    </script>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js" integrity="sha512-a+SUDuwNzXDvz4XrIcXHuCf089/iJAoN4lmrXJg18XnduKK6YlDHNRalv4yd1N40OKI80tFidF+rqTFKGPoWFQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="assets/js/script.js"></script>
  </body>
</html>